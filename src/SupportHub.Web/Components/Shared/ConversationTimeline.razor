@namespace SupportHub.Web.Components.Shared
@using SupportHub.Application.DTOs

<div class="conversation-timeline">
    @foreach (var entry in GetSortedEntries())
    {
        @if (entry.IsNote)
        {
            @if (IsAgent)
            {
                <MudPaper Class="pa-3 my-2" Style="background-color: #fff8e1; border-left: 4px solid orange;">
                    <div class="d-flex justify-space-between">
                        <MudText Typo="Typo.caption" Color="Color.Warning"><b>Internal Note</b> â€” @entry.AuthorName</MudText>
                        <MudText Typo="Typo.caption">@entry.CreatedAt.LocalDateTime.ToString("g")</MudText>
                    </div>
                    <MudText Class="mt-1">@entry.Body</MudText>
                </MudPaper>
            }
        }
        else
        {
            var isOutbound = entry.Direction == MessageDirection.Outbound;
            <MudPaper Class="@($"pa-3 my-2 {(isOutbound ? "ml-8" : "mr-8")}")"
                      Style="@(isOutbound ? "background-color: #e3f2fd;" : "background-color: #f5f5f5;")">
                <div class="d-flex justify-space-between">
                    <MudText Typo="Typo.caption"><b>@(entry.SenderName ?? (isOutbound ? "Support Agent" : "Requester"))</b></MudText>
                    <MudText Typo="Typo.caption">@entry.CreatedAt.LocalDateTime.ToString("g")</MudText>
                </div>
                <MudText Class="mt-1">@entry.Body</MudText>
                @if (entry.Attachments?.Any() == true)
                {
                    <div class="mt-2">
                        @foreach (var att in entry.Attachments)
                        {
                            <MudChip T="string" Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small">@att.OriginalFileName</MudChip>
                        }
                    </div>
                }
            </MudPaper>
        }
    }
</div>

@code {
    [Parameter] public IReadOnlyList<TicketMessageDto> Messages { get; set; } = [];
    [Parameter] public IReadOnlyList<InternalNoteDto> Notes { get; set; } = [];
    [Parameter] public bool IsAgent { get; set; }

    private record TimelineEntry(bool IsNote, DateTimeOffset CreatedAt, string Body,
        string? AuthorName, string? SenderName, MessageDirection Direction,
        IReadOnlyList<TicketAttachmentDto>? Attachments);

    private IEnumerable<TimelineEntry> GetSortedEntries()
    {
        var msgEntries = Messages.Select(m => new TimelineEntry(
            false, m.CreatedAt, m.Body, null, m.SenderName, m.Direction, m.Attachments));
        var noteEntries = Notes.Select(n => new TimelineEntry(
            true, n.CreatedAt, n.Body, n.AuthorName, null, MessageDirection.Inbound, null));
        return msgEntries.Concat(noteEntries).OrderBy(e => e.CreatedAt);
    }
}
